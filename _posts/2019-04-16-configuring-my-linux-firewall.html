---
layout: post
title: Configuring my Linux Firewall
date: '2019-04-16T10:50:00.001-07:00'
author: "@eamoc"
tags: 
modified_time: '2019-04-16T14:18:45.615-07:00'
blogger_id: tag:blogger.com,1999:blog-6955428370236550107.post-2680753248682076874
blogger_orig_url: https://eamoc.blogspot.com/2019/04/configuring-my-linux-firewall.html
---

<span style="font-weight: 400;">A firewall is a program that surrounds  the interface between a private network and the rest of the internet. Its a gateway that follows pre-configured rules. It allows certain traffic to pass through  from the internet to the private network and blocks those that are  unwanted and potentially harmful.</span><br /><br /><span style="font-weight: 400;"><span style="font-weight: 400;">The Linux kernel is able to  filter incoming and outgoing packages with a tool known as  ‘Iptables’. </span>Based on a particular ruleset, this tool decides which data packets to allow across the network interface, and which ones to block.</span><br /><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">First off install <b>iptables</b> </span><br /><span style="font-weight: 400;"><b>➜sudo xbps-install -S iptables</b></span><br /><span style="font-weight: 400;"><b>&nbsp;</b>I may as well install the suite of network tools that come with void:</span><br /><br /><span style="font-weight: 400;"><span style="font-weight: 400;"><b>➜sudo xbps-install -S inetutils</b></span> <br />[*] Updating `https://alpha.de.repo.voidlinux.org/current/x86_64-repodata' ...<br /><br />Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Action&nbsp;&nbsp;&nbsp; Version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; New version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Download size<br />inetutils-dnsdomainname install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 22KB <br />inetutils-ftp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 98KB <br />inetutils-hostname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 24KB <br />inetutils-ifconfig&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 39KB <br />inetutils-inetd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 34KB <br />inetutils-ping&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 40KB <br />inetutils-rexec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 31KB <br />inetutils-syslog&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 43KB <br />inetutils-telnet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 78KB <br />inetutils-tftp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 37KB <br />inetutils-traceroute&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 26KB <br />inetutils-uucpd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 23KB <br />inetutils-whois&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 31KB <br />inetutils-rcp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 28KB <br />inetutils-rlogin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 38KB <br />inetutils-rsh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 33KB <br />inetutils-talk&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 40KB <br />inetutils&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; install&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.9.4_10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 62KB <br /><br />Size to download:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 735KB<br />Size required on disk:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2879KB<br />Space available on disk:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 93GB<br /><br />Do you want to continue? [Y/n]&nbsp;</span><br /><br /><br /><span style="font-weight: 400;">The rules that <b>iptables</b> uses are referred to as chains.</span><br /><div class="line874">These are 3 predefined chains in the filter table to  which we can add rules for processing IP packets passing through those  chains. These chains are: <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span></div><ul><li>INPUT - All packets destined for the host computer. <span class="anchor" id="line-21"></span></li><li>OUTPUT - All packets originating from the host computer. <span class="anchor" id="line-22"></span></li><li>FORWARD  - All packets neither destined for nor originating from the host  computer, but passing through (routed by) the host computer. This chain  is used if you are using your computer as a router. <span class="anchor" id="line-23"></span></li></ul>For  the most part, we are going to be dealing with the INPUT chain to  filter packets entering our machine.<br /><br />There are three actions which the iptables can perform on the traffic:<br /><ul><li><b>ACCEPT</b></li><b></b><li><b>DROP</b></li><li><b>REJECT</b></li></ul><b>1. ACCEPT</b><br />When traffic passes the rules in its specified chain, then the iptable accepts the traffic.<br /><b>2. DROP</b><br />When the traffic is unable to pass the rules in its specified chain, the iptable blocks that traffic. That means the firewall is closed.<br /><b>3. REJECT</b><br />This type of action is similar to the drop action but it sends a message  to the sender of the traffic stating that the data transfer has failed.<br /><br />As a gene<span style="font-family: inherit;">ral rule, use REJECT when you want the other end to know the  port is unreachable, use DROP </span>for connections to hosts you don’t want  people to see.<br /><br />Rules are added in a list to each chain. A packet is checked against  each rule in turn, starting at the top, and if it matches that rule,  then an action is taken such as accepting (ACCEPT) or dropping (DROP)  the packet. Once a rule has been matched and an action taken, then the  packet is processed according to the outcome of that rule and isn't  processed by further rules in the chain. If a packet passes down through  all the rules in the chain and reaches the bottom without being matched  against any rule, then the default action for that chain is taken. This  is referred to as the default policy and may be set to either ACCEPT or  DROP the packet.<br /><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">To start from scratch, run <b>iptables</b> with the <b>-F</b> flag. This will flush out the existing chains if any.</span><br /><br /><span style="font-weight: 400;"><b>sudo iptables -F</b></span><br /><span style="font-weight: 400;"><b>&nbsp;</b>&nbsp;</span><br /><span style="font-weight: 400;">The first thing to do is to create the&nbsp; default policy. There are two ways of going about this.</span><br /><span style="font-weight: 400;">Either&nbsp; DROP all packets by defauilt and then ACCEPT packets from trusted IP addresses or certain ports, or ACCEPT packets by default, and then DROP, from nuisance IP addresses or ports.</span><br />Generally,  option 1 above is used for the INPUT chain where we want to control  what is allowed to access our machine and option 2 would be used for the  OUTPUT chain where we generally trust the traffic that is leaving  (originating from) our machine.<br /><br /><b>➜ sudo iptables -P INPUT DROP</b><br /><b>➜ sudo iptables -P FORWARD DROP</b><br /><b>➜ sudo iptables -P OUTPUT ACCEPT&nbsp;</b><br /><b><br /></b>Accept packets on localhost:<br /><b><br /></b><b>➜ sudo iptables -A INPUT -i lo -j ACCEPT</b><br /><b>➜ sudo iptables -A OUTPUT -o lo -j ACCEPT</b><br /><br /><div class="line891">Now it's time to start adding some rules. We use the -A switch to  append (or add) a rule to a specific chain, the INPUT chain in this  instance. Then we use the -i switch (for interface) to specify packets  matching or destined for the lo (localhost, 127.0.0.1) interface and  finally -j (jump) to the target action for packets matching the rule -  in this case ACCEPT. So this rule will allow all incoming packets  destined for the localhost interface to be accepted. This is generally  required as many software applications expect to be able to communicate  with the localhost adapter.&nbsp;</div><div class="line891"></div><div class="line891"><span class="anchor" id="line-116"></span></div><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">Now we set up a rule to allow established sessions to receive traffic.</span><br /><span style="font-weight: 400;"><b><br /></b></span><span style="font-weight: 400;"><b>➜ sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</b></span><br /><br /><span style="font-weight: 400;">Here we use the <b>-A</b> flag to append rules to the INPUT chain. <b>-m conntrack</b> allows filter rules to match based on connection state. It allows the use of the <b>--ctstate</b> option. <b>--ctstate</b> defines the list of states for the rule to match on. Valid states are:</span><br /><ul><li>NEW - The connection has not yet been seen. <span class="anchor" id="line-32"></span></li><li>RELATED - The connection is new, but is related to another connection already permitted. <span class="anchor" id="line-33"></span></li><li>ESTABLISHED - The connection is already established. <span class="anchor" id="line-34"></span></li><li>INVALID - The traffic couldn't be identified for some reason </li></ul><br /><span style="font-weight: 400;">Finally allow SSH to connect remotely, in case of any disaster recovery etc. or if I need to patch in from elsewhere:</span><br /><br /><span style="font-weight: 400;"><b>➜ sudo iptables -I INPUT -p tcp --dport 22 -j ACCEPT</b></span><br /><br /><span style="font-weight: 400;">This commmand uses the <b>-I</b> flag to insert the rule at the top of the chain. The <b>-p</b> flag is then used tp specify a protocol, in this case TCP, and then destination port 22. I.e. ssh transmits on port 22.</span><br /><span style="font-weight: 400;">Finally I write the <b>iptable</b> changes to file. Note how this must be done as root.</span><br /><br /><span style="font-weight: 400;"><b>➜ su root<br />Password: <br /># iptables-save &gt; /etc/firewall.conf<br /># </b><br />&nbsp;</span><br /><span style="font-weight: 400;">Now I can list the rules for iptables:&nbsp;</span><br /><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;"><b>&nbsp;➜ sudo iptables -L<br />Password: <br />Chain INPUT (policy DROP)<br />target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; --&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:ssh<br />ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; --&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; --&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctstate RELATED,ESTABLISHED<br /><br />Chain FORWARD (policy DROP)<br />target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />Chain OUTPUT (policy ACCEPT)<br />target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; --&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp; </b></span><br /><span style="font-weight: 400;">We can see these rules also if we look at our new firewall.conf file.</span><br /><br /><b>&nbsp;➜ cat /etc/firewall.conf <br /># Generated by iptables-save v1.8.2 on Tue Apr 16 18:34:01 2019<br />*filter<br />:INPUT DROP [564:78938]<br />:FORWARD DROP [0:0]<br />:OUTPUT ACCEPT [4698:472178]<br />-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT<br />-A INPUT -i lo -j ACCEPT<br />-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT<br />-A OUTPUT -o lo -j ACCEPT<br />COMMIT<br /># Completed on Tue Apr 16 18:34:01 2019</b><br /><br />For these rules to be persistent, we need to set up a service to read this file on startup.<br />Replace the contents of <b>/etc/sv/iptables/run </b>with this:<br /><br /><b></b> <br /><h2><span class="mw-headline" id=".2Fetc.2Fsv.2Fiptables.2Frun"><br /></span></h2>